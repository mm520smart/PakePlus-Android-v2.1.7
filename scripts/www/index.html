<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.2, user-scalable=yes">
    <title>æ—¶å…‰è½¬ç›˜ Â· å…«å­—èµ·ä¾‹</title>
    <!-- è½¬ç›˜äº¤äº’&åˆ†æ­¥å¯¼èˆª Â· å®Œå…¨å“åº”å¼ Â· æ–°å¢å†å²è®°å½• -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Serif SC', 'PingFang SC', 'Ma Shan Zheng', 'Segoe UI', sans-serif;
        }
        body {
            background: #3e2c1b;
            background: radial-gradient(circle at 30% 40%, #5a4230, #2a1e15);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
        }
        .app-wizard {
            max-width: 420px;
            width: 100%;
            background: #fdf3e0;
            background-image: linear-gradient(165deg, #fff7e6, #f3e3cc);
            border-radius: 56px 56px 40px 40px;
            box-shadow: 0 25px 35px -10px #0f0a07;
            border: 2px solid #ad8a67;
            padding: 22px 20px 30px;
            position: relative;
        }

        /* æ­¥éª¤é¢æ¿ â€”â€” åŠ¨æ€åˆ‡æ¢ */
        .step-panel {
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fade 0.2s ease;
        }
        .step-panel.active {
            display: flex;
        }
        @keyframes fade { 0%{opacity:0.6;} 100%{opacity:1;} }

        /* ========= å°é¢åœºæ™¯ Â· æ–°å¢å†å²è®°å½•åŒº ========= */
        .cover-scene {
            text-align: center;
            padding: 10px 10px 20px;
            width: 100%;
        }
        .cover-logo {
            font-size: 4.2rem;
            text-shadow: 6px 8px 0 #bb9a79;
            color: #2f200e;
            margin-bottom: 5px;
            letter-spacing: 16px;
        }
        .cover-title {
            font-size: 2rem;
            font-weight: 800;
            color: #4d2f19;
            background: #e9d2b0;
            display: inline-block;
            padding: 10px 28px;
            border-radius: 100px 20px 100px 20px;
            border: 3px solid #ad7a55;
            box-shadow: inset 0 -3px 0 #6b4f37;
            margin-bottom: 12px;
        }
        .cover-sub {
            color: #674f38;
            border-top: 2px dashed #ba9a7a;
            border-bottom: 2px dashed #ba9a7a;
            padding: 12px 0;
            font-size: 1.1rem;
            margin: 15px 0 20px;
            letter-spacing: 4px;
        }
        /* ---------- å†å²è®°å½•å¡ç‰‡ ---------- */
        .history-section {
            background: #ddcbb2;
            border-radius: 40px 40px 20px 20px;
            padding: 16px 14px;
            margin: 10px 0 20px;
            box-shadow: inset 0 -3px 0 #8f735a, inset 0 2px 12px #ffe6bf;
            border: 2px solid #9c8264;
        }
        .history-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            color: #2d231a;
            background: #b29473;
            padding: 6px 16px;
            border-radius: 50px;
            width: fit-content;
            color: white;
            margin-bottom: 12px;
            border: 1px solid #efd4a4;
        }
        .history-list {
            max-height: 160px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 4px;
        }
        .history-item {
            background: #fcf3df;
            border-radius: 30px 8px 30px 8px;
            padding: 10px 16px;
            border: 2px solid #b2895a;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            box-shadow: 0 3px 0 #715b42;
            color: #2e1e0e;
        }
        .history-bazi {
            font-weight: 800;
            font-size: 0.95rem;
            letter-spacing: 2px;
            background: #513e2b;
            color: #ffddb0;
            padding: 3px 12px;
            border-radius: 30px;
        }
        .cover-btn {
            background: #ba7b4b;
            border-bottom: 12px solid #5f3e26;
            font-size: 2rem;
            padding: 14px 45px;
            border-radius: 60px 20px 60px 20px;
            color: white;
            font-weight: bold;
            box-shadow: 0 12px 0 #3f2b1b;
            transition: 0.06s;
            border: none;
            width: 100%;
            letter-spacing: 18px;
            text-shadow: 3px 3px 0 #4c2e18;
            cursor: pointer;
        }
        .cover-btn:active {
            transform: translateY(8px);
            box-shadow: 0 4px 0 #3f2b1b;
            border-bottom-width: 6px;
        }

        /* ======== é€šç”¨å¯¼èˆªæ¡ ======== */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin-top: 28px;
            gap: 12px;
        }
        .nav-btn {
            background: #9f8b70;
            border: none;
            border-bottom: 6px solid #584733;
            padding: 12px 18px;
            border-radius: 48px 12px 48px 12px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #fff9e0;
            flex: 1;
            text-shadow: 1px 2px 0 #3f3429;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: 0 6px 0 #413424;
            transition: 0.03s;
            cursor: pointer;
        }
        .nav-btn:active {
            transform: translateY(6px);
            box-shadow: 0 1px 0 #413424;
            border-bottom-width: 3px;
        }
        .finish-btn {
            background: #4f773c;
            border-bottom-color: #2a401f;
            box-shadow: 0 6px 0 #25331c;
        }

        /* ======= è½¬ç›˜é€šç”¨ ======= */
        .dial-panel {
            background: #eedcbf;
            border-radius: 110px 110px 60px 60px;
            padding: 24px 16px;
            margin: 5px 0 10px;
            width: 100%;
            box-shadow: inset 0 -5px 0 #a58463, inset 0 5px 20px #ffeac1;
            border: 2px solid #7c6248;
        }
        .dial-label {
            font-size: 1.2rem;
            background: #51412e;
            color: #ffddaa;
            padding: 6px 22px;
            border-radius: 60px;
            margin-bottom: 22px;
            border: 1px solid #eab767;
            letter-spacing: 6px;
        }

        /* åŒå¿ƒåœ†è½¬ç›˜ â€”â€” ä¸‰å±‚æ—¶ã€åˆ†ã€ç§’ */
        .concentric-dials {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            margin: 8px 0;
        }
        .circle-layer {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            background: rgba(161, 126, 94, 0.2);
            border-radius: 100px;
            padding: 14px 8px;
        }
        .ring-label {
            font-size: 0.9rem;
            color: #4d2a19;
            font-weight: 600;
            align-self: flex-start;
            margin-left: 10px;
        }
        .slider-hour, .slider-minute, .slider-second {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        .time-scroll {
            display: flex;
            align-items: center;
            background: #fffaec;
            border-radius: 60px;
            padding: 6px 12px;
            border: 3px solid #8b6547;
            box-shadow: inset 0 2px 8px #ac8c6b;
            flex: 1;
        }
        .time-value {
            font-size: 2rem;
            font-weight: 800;
            font-family: 'Courier New', monospace;
            color: #302010;
            background: #ffeec2;
            padding: 0 15px;
            border-radius: 30px;
            line-height: 1.4;
        }
        .spin-arrow {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .arrow-up, .arrow-down {
            background: #c3a07e;
            border: none;
            border-bottom: 4px solid #665035;
            font-size: 1.3rem;
            width: 46px;
            height: 46px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 0 #4b3a2b;
            transition: 0.02s;
            cursor: pointer;
        }
        .arrow-up:active, .arrow-down:active {
            transform: translateY(4px);
            box-shadow: 0 1px 0 #4b3a2b;
            border-bottom-width: 2px;
        }

        /* æœˆä»½/æ—¥æœŸ è½¬ç›˜ç®€åŒ–â€”â€” åŒæ ·è½¬ç›˜é£æ ¼ */
        .month-dial, .day-dial {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
        }
        .month-item, .day-item {
            background: #e4d4ba;
            border-radius: 40px 12px 40px 12px;
            padding: 12px 18px;
            font-size: 1.6rem;
            font-weight: 700;
            border: 3px solid #a6794b;
            color: #3e2c14;
            box-shadow: 0 6px 0 #70583c;
            transition: 0.03s;
            min-width: 90px;
            text-align: center;
            cursor: pointer;
        }
        .month-item.selected, .day-item.selected {
            background: #c5935e;
            color: #fff5d5;
            border-color: #ffc489;
            transform: scale(0.96);
            box-shadow: 0 2px 0 #5f432b;
        }

        /* ========= æ­¥éª¤3ï¼šæœˆä»½è½¬ç›˜ (èŠ‚æ°”) é«˜åº¦å‹ç¼©ä¸ºåŸæ¥çš„80% ========= */
        #step3 .dial-panel { padding: 19px 13px; }
        #step3 .month-item { padding: 10px 14px; font-size: 1.4rem; min-width: 75px; margin: 0; }
        #step3 .dial-label { margin-bottom: 16px; padding: 5px 18px; font-size: 1.1rem; }
        #step3 .month-dial { gap: 8px; }
        #step3 .dial-panel div[style*="margin-top: 16px"] { margin-top: 12px !important; padding: 8px !important; }
        #step3 p { margin-top: 8px !important; font-size: 0.7rem !important; }

        /* ========= æ­¥éª¤5ï¼šä¸‰å±‚åŒå¿ƒåœ† Â· æ—¶åˆ†ç§’ é«˜åº¦å‹ç¼©ä¸ºåŸæ¥çš„80% ========= */
        #step5 .dial-panel { padding: 19px 13px; }
        #step5 .dial-label { margin-bottom: 16px; padding: 5px 18px; font-size: 1.1rem; }
        #step5 .concentric-dials { gap: 14px; margin: 6px 0; }
        #step5 .circle-layer { padding: 11px 6px; }
        #step5 .ring-label { font-size: 0.8rem; margin-left: 8px; margin-bottom: 2px; }
        #step5 .time-scroll { padding: 5px 10px; border-width: 2.4px; }
        #step5 .time-value { font-size: 1.6rem; padding: 0 12px; border-radius: 24px; }
        #step5 .time-value + span { font-size: 1.2rem !important; }
        #step5 .spin-arrow { gap: 1px; }
        #step5 .arrow-up, #step5 .arrow-down { width: 38px; height: 38px; font-size: 1.1rem; border-bottom-width: 3px; box-shadow: 0 3px 0 #4b3a2b; }
        #step5 .arrow-up:active, #step5 .arrow-down:active { transform: translateY(3px); box-shadow: 0 1px 0 #4b3a2b; border-bottom-width: 1.5px; }
        #step5 .dial-panel div[style*="background:#4a3b2b"] { margin-top: 12px !important; padding: 5px !important; border-radius: 30px !important; }
        #step5 .dial-panel div[style*="background:#4a3b2b"] span { font-size: 0.95rem !important; }

        /* å¹´ä»½è¾“å…¥ */
        .year-input-area {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #d6bb99;
            padding: 16px 20px;
            border-radius: 80px;
            margin: 15px 0;
        }
        .year-big {
            font-size: 2.4rem;
            width: 140px;
            text-align: center;
            background: #fff4d3;
            border: 5px solid #966842;
            border-radius: 40px 8px 40px 8px;
            padding: 8px 0;
            font-weight: 700;
        }

        /* æœ€ç»ˆæ’ç›˜ç»“æœ */
        .bazi-panel {
            background: #302818;
            padding: 24px 18px;
            border-radius: 48px 12px 48px 12px;
            border: 3px solid #eabf7e;
            box-shadow: inset 0 0 0 2px #1e160e;
            margin: 18px 0 8px;
            width: 100%;
        }
        .bazi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            text-align: center;
        }
        .bazi-item {
            background: #fbeac5;
            padding: 14px 4px;
            border-radius: 30px 6px 30px 6px;
            border: 2px solid #cfaa74;
            color: #312017;
            font-weight: 800;
        }
        .ganzhi-big {
            font-size: 1.8rem;
            letter-spacing: 6px;
        }
        .footer-note {
            color: #bdb09b;
            margin-top: 12px;
        }
    </style>
</head>
<body>
    <div class="app-wizard">
        <!-- ========= æ­¥éª¤1ï¼šå°é¢ Â· æ–°å¢å†å²è®°å½• ========= -->
        <div id="step1" class="step-panel active">
            <div class="cover-scene">
                <div class="cover-logo">ğŸªâ¿»</div>
                <div class="cover-title">æ—¶Â·ç›˜</div>
                <div style="font-size:2.8rem; letter-spacing: 12px; color:#64482e;">å¸ˆçˆ¶ä¸“äº«</div>
                <div class="cover-sub">æ’ç›˜æ¨å››æŸ±</div>
                
                <!-- â˜… å†å²è®°å½•åŒºåŸŸ â˜… -->
                <div class="history-section">
                    <div class="history-title">
                        <span style="font-size:1.4rem;">ğŸ“‹</span> å†å²æ’ç›˜
                    </div>
                    <div id="historyList" class="history-list">
                        <!-- åŠ¨æ€æ¸²æŸ“å†å²è®°å½• -->
                    </div>
                </div>
                
                <button class="cover-btn" onclick="goToStep(2)">å¯ ç›˜</button>
            </div>
        </div>

        <!-- ========= æ­¥éª¤2ï¼šè¾“å…¥å¹´ä»½ ========= -->
        <div id="step2" class="step-panel">
            <div style="display: flex; flex-direction: column; align-items: center; width:100%;">
                <span style="font-size:2rem; background: #9a7b5b; color: #fff2c4; padding:6px 30px; border-radius:0 0 40px 40px;">ğŸ“† å¹´æŸ±</span>
                <div style="height: 20px;"></div>
                <div class="dial-panel" style="background: #e7cfaf;">
                    <div class="dial-label">âš“ ç«‹æ˜¥ä¸ºç•Œ</div>
                    <div class="year-input-area">
                        <span style="font-size:2rem;">å…¬å…ƒ</span>
                        <input type="number" id="yearInput" class="year-big" value="2026" min="1900" max="2100" step="1">
                    </div>
                    <div style="font-size:1rem; color: #553e2a; background:#ffe2b3; padding:8px; border-radius:60px;">ç«‹æ˜¥å‰ä»å±ä¸Šå¹´ï¼Œè‡ªåŠ¨æ ¡æ­£</div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="goToStep(1)">â—€ ä¸Šä¸€æ­¥</button>
                    <button class="nav-btn" onclick="goToStep(3)">ä¸‹ä¸€æ­¥ â–¶</button>
                </div>
            </div>
        </div>

        <!-- ========= æ­¥éª¤3ï¼šæœˆä»½è½¬ç›˜ (èŠ‚æ°”) ========= -->
        <div id="step3" class="step-panel">
            <div style="width:100%; display: flex; flex-direction: column;">
                <span style="font-size:1.8rem; background: #6f7e5b; color: white; padding:6px 20px; border-radius:40px 40px 0 0;">ğŸŒ™ æœˆæŸ± Â· èŠ‚æ°”è½¬ç›˜</span>
                <div class="dial-panel">
                    <div class="dial-label"> é€‰æœˆ(èŠ‚ä»¤)</div>
                    <div class="month-dial" id="monthDial"></div>
                    <div style="margin-top: 16px; background: #f8e7c9; padding: 10px; border-radius: 36px;">
                        <span id="selectedMonthHint" style="font-size:1.4rem;">æ­£æœˆ ç«‹æ˜¥Â·å¯…</span>
                    </div>
                    <p style="font-size:0.8rem; margin-top:12px;">* ä»¥èŠ‚ä¸ºæœˆä»¤åˆ†ç•Œ</p>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="goToStep(2)">â—€ ä¸Šä¸€æ­¥</button>
                    <button class="nav-btn" onclick="goToStep(4)">ä¸‹ä¸€æ­¥ â–¶</button>
                </div>
            </div>
        </div>

        <!-- ========= æ­¥éª¤4ï¼šæ—¥æœŸè½¬ç›˜ ========= -->
        <div id="step4" class="step-panel">
            <div style="width:100%;">
                <span style="font-size:1.8rem; background: #916a42; color: white; padding:6px 30px; border-radius: 30px 30px 0 0;">â˜€ï¸ æ—¥æŸ±</span>
                <div class="dial-panel">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:1.2rem;">ğŸ“… æ—¥æœŸé€‰æ‹©</span>
                        <span style="background:#78644b; padding:6px 16px; border-radius:40px; color:white;">ä¸‡å¹´å†æ¨æ¼”</span>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:12px; margin:22px 0;">
                        <span style="font-size:2rem;">æœˆ</span>
                        <select id="monthSelect" style="font-size:1.8rem; width:100px; text-align:center; background:#ffefcf; border-radius:30px 6px 30px 6px; border:4px solid #976b42; padding:8px;" onchange="updateDaySelect()"></select>
                        <span style="font-size:2rem;">æ—¥</span>
                        <select id="daySelect" style="font-size:1.8rem; width:100px; background:#ffefcf; border-radius:6px 30px 6px 30px; border:4px solid #976b42; padding:8px;"></select>
                    </div>
                    <div style="background:#e1cbb0; padding:8px; border-radius:40px; font-size:1.2rem;">
                        æ‰€é€‰ï¼š<span id="selectedDateDisplay">2026å¹´2æœˆ12æ—¥</span>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="goToStep(3)">â—€ ä¸Šä¸€æ­¥</button>
                    <button class="nav-btn" onclick="goToStep(5)">ä¸‹ä¸€æ­¥ â–¶</button>
                </div>
            </div>
        </div>

        <!-- ========= æ­¥éª¤5ï¼šä¸‰å±‚åŒå¿ƒåœ† Â· æ—¶åˆ†ç§’ ========= -->
        <div id="step5" class="step-panel">
            <div style="width:100%;">
                <span style="font-size:1.6rem; background: #2c4a3b; color: white; padding:6px 18px; border-radius: 30px 30px 0 0;">â±ï¸ æ—¶Â·åˆ†Â·ç§’ Â· ä¸‰åŒå¿ƒç›˜</span>
                <div class="dial-panel" style="background: #cbb294;">
                    <div class="concentric-dials">
                        <!-- æ—¶åœˆ -->
                        <div class="circle-layer" style="border:3px solid #8f6e4c; border-radius: 100px;">
                            <span class="ring-label">ğŸ• æ—¶ (å­~äº¥)</span>
                            <div class="slider-hour">
                                <div class="time-scroll">
                                    <span id="hourValue" class="time-value">11</span>
                                    <span style="font-size:1.5rem;">æ—¶</span>
                                </div>
                                <div class="spin-arrow">
                                    <button class="arrow-up" onclick="adjustTime('hour', 1)">â–²</button>
                                    <button class="arrow-down" onclick="adjustTime('hour', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <!-- åˆ†åœˆ -->
                        <div class="circle-layer" style="border:3px solid #9e7a5a;">
                            <span class="ring-label">â²ï¸ åˆ†</span>
                            <div class="slider-minute">
                                <div class="time-scroll">
                                    <span id="minuteValue" class="time-value">30</span>
                                    <span style="font-size:1.5rem;">åˆ†</span>
                                </div>
                                <div class="spin-arrow">
                                    <button class="arrow-up" onclick="adjustTime('minute', 1)">â–²</button>
                                    <button class="arrow-down" onclick="adjustTime('minute', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                        <!-- ç§’åœˆ -->
                        <div class="circle-layer" style="border:3px solid #ac8866;">
                            <span class="ring-label">ğŸ•’ ç§’</span>
                            <div class="slider-second">
                                <div class="time-scroll">
                                    <span id="secondValue" class="time-value">15</span>
                                    <span style="font-size:1.5rem;">ç§’</span>
                                </div>
                                <div class="spin-arrow">
                                    <button class="arrow-up" onclick="adjustTime('second', 1)">â–²</button>
                                    <button class="arrow-down" onclick="adjustTime('second', -1)">â–¼</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="background:#4a3b2b; color: #ffdcaa; padding:6px; border-radius: 36px; margin-top: 16px;">
                        <span id="timeDisplay">11æ—¶30åˆ†15ç§’</span>
                    </div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn" onclick="goToStep(4)">â—€ ä¸Šä¸€æ­¥</button>
                    <button class="nav-btn finish-btn" onclick="completeBazi()">ğŸ”¯ å®Œæˆæ’ç›˜</button>
                </div>
            </div>
        </div>

        <!-- ========= æ­¥éª¤6ï¼šç»“æœ(æ’ç›˜) ========= -->
        <div id="step6" class="step-panel" style="padding:10px 0;">
            <div style="background:#dab07f; padding:10px; border-radius: 50px 50px 20px 20px; width:100%;">
                <span style="font-size:1.8rem;">ğŸ“œæ’ç›˜ç»“æœ</span>
            </div>
            <div class="bazi-panel" id="baziResultPanel">
                <div class="bazi-grid" id="baziGrid">
                    <div class="bazi-item"><span>å¹´æŸ±</span><div id="baziYear" class="ganzhi-big">ä¸™åˆ</div></div>
                    <div class="bazi-item"><span>æœˆæŸ±</span><div id="baziMonth" class="ganzhi-big">åºšå¯…</div></div>
                    <div class="bazi-item"><span>æ—¥æŸ±</span><div id="baziDay" class="ganzhi-big">ä¹™ä¸‘</div></div>
                    <div class="bazi-item"><span>æ—¶æŸ±</span><div id="baziHour" class="ganzhi-big">æˆŠå­</div></div>
                </div>
                <div style="margin-top:20px; background:#1e1a12; padding:10px; border-radius:30px;">
                    <p id="detailTime" style="color:#fdebb3;">å…¬å…ƒ2026å¹´2æœˆ12æ—¥ 11:30:15</p>
                </div>
            </div>
            <div class="nav-buttons">
                <button class="nav-btn" onclick="goToStep(5)">â—€ ä¸Šä¸€æ­¥</button>
                <!-- â˜… é¦–é¡µæŒ‰é’®ï¼šæ”¹ä¸ºè®°å½•+æ¸…ç©º+å›å®¶ â˜… -->
                <button class="nav-btn" onclick="recordAndGoHome()">ğŸ  é¦–é¡µ</button>
            </div>
        </div>
    </div>

    <script>
        // ---------- ğŸŒŸ æ ¸å¿ƒå…¨å±€æ•°æ® ----------
        let globalData = {
            year: 2026,
            month: 2,      // å…¬å†æœˆ
            day: 12,
            hour: 11,
            minute: 30,
            second: 15,
            solarTermMonth: 1  // é»˜è®¤æƒŠè›°ï¼ˆå¯æœˆï¼‰
        };

        // ---------- å¤©å¹²åœ°æ”¯è¡¨ ----------
        const sky = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±","åºš","è¾›","å£¬","ç™¸"];
        const ground = ["å­","ä¸‘","å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥"];
        const ganzhiCycle = Array.from({length:60}, (_,i)=> sky[i%10] + ground[i%12]);

        // ---------- èŠ‚æ°”æœˆæ˜ å°„ ----------
        const solarTerms = ["ç«‹æ˜¥","æƒŠè›°","æ¸…æ˜","ç«‹å¤","èŠ’ç§","å°æš‘","ç«‹ç§‹","ç™½éœ²","å¯’éœ²","ç«‹å†¬","å¤§é›ª","å°å¯’"];
        const monthGround = ["å¯…","å¯","è¾°","å·³","åˆ","æœª","ç”³","é…‰","æˆŒ","äº¥","å­","ä¸‘"];

        // ========== ğŸ“œ å†å²è®°å½•ç³»ç»Ÿ ==========
        let historyRecords = [];

        // æ¸²æŸ“å†å²åˆ—è¡¨
        function renderHistory() {
            const historyDiv = document.getElementById('historyList');
            if (!historyDiv) return;
            if (historyRecords.length === 0) {
                historyDiv.innerHTML = '<div style="color:#7a5a3a; text-align:center; padding:12px; background:#f0e0c6; border-radius:30px;">âœ¨ æš‚æ— æ’ç›˜è®°å½•</div>';
                return;
            }
            let html = '';
            // å€’åºæ˜¾ç¤ºï¼ˆæœ€æ–°çš„åœ¨ä¸Šï¼‰
            for (let i = 0; i < historyRecords.length; i++) {
                const rec = historyRecords[i];
                html += `<div class="history-item">
                            <span style="font-size:0.75rem; background: #cbad89; padding:4px 8px; border-radius:40px; color:#1f150d;">${rec.datetime}</span>
                            <span class="history-bazi">${rec.bazi}</span>
                        </div>`;
            }
            historyDiv.innerHTML = html;
        }

        // æ–°å¢å†å²è®°å½•
        function addHistoryRecord(record) {
            historyRecords.unshift(record);   // æœ€æ–°è®°å½•æ’åˆ°æœ€å‰
            // æœ€å¤šä¿ç•™10æ¡ï¼Œé˜²æ­¢æº¢å‡º
            if (historyRecords.length > 10) historyRecords.pop();
            renderHistory();
        }

        // ---------- äº”è™é ----------
        function getMonthGan(yearGanIndex, monthZhiIndex) {
            const startGanMap = {0:2,1:2, 2:8,3:8, 4:6,5:6, 6:2,7:2, 8:4,9:4};
            let startGan = startGanMap[yearGanIndex];
            let offset = monthZhiIndex;
            let ganIdx = (startGan + offset) % 10;
            return ganIdx;
        }

        // ---------- äº”é¼ é ----------
        function getHourGan(dayGanIndex, hourZhiIndex) {
            const wushuMap = {0:0,1:0, 2:2,3:2, 4:4,5:4, 6:6,7:6, 8:8,9:8};
            let start = wushuMap[dayGanIndex];
            let ganIdx = (start + hourZhiIndex) % 10;
            return ganIdx;
        }

        function calcYearGanzhi(year) {
            let ganIdx = (year - 4) % 10;
            if (ganIdx < 0) ganIdx += 10;
            let zhiIdx = (year - 4) % 12;
            if (zhiIdx < 0) zhiIdx += 12;
            return sky[ganIdx] + ground[zhiIdx];
        }

        function calcDayGanzhi(year, month, day) {
            let baseYear = 2000, baseMonth = 1, baseDay = 1, baseGanZhiIndex = 30; //ç”²åˆ
            let totalDays = 0;
            for (let y = baseYear; y < year; y++) {
                totalDays += ( (y%4===0 && y%100!==0) || y%400===0 ) ? 366 : 365;
            }
            for (let m = 1; m < month; m++) totalDays += daysInMonth(year, m);
            totalDays += (day - baseDay);
            let idx = (baseGanZhiIndex + totalDays) % 60;
            return ganzhiCycle[idx];
        }
        function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

        function getHourZhi(hour, minute) {
            let h = hour;
            if (h === 23) return 0;
            if (h < 0) return 0;
            if (h === 0) return 0;
            let zhiIdx = Math.floor((h + 1) / 2) % 12;
            if (h === 23) zhiIdx = 0;
            return zhiIdx;
        }

        function calcMonthGanzhi(year, termMonthIdx) {
            let yearGanzhi = calcYearGanzhi(year);
            let yearGan = yearGanzhi[0];
            let yearGanIdx = sky.indexOf(yearGan);
            let monthZhiIdx = termMonthIdx; 
            let monthGanIdx = getMonthGan(yearGanIdx, monthZhiIdx);
            return sky[monthGanIdx] + ground[monthZhiIdx];
        }

        function calcHourGanzhi(dayGanzhi, hourZhiIdx) {
            let dayGan = dayGanzhi[0];
            let dayGanIdx = sky.indexOf(dayGan);
            let hourGanIdx = getHourGan(dayGanIdx, hourZhiIdx);
            return sky[hourGanIdx] + ground[hourZhiIdx];
        }

        // ========== ğŸ§¹ é‡ç½®æ‰€æœ‰æ•°æ®ä¸ºé»˜è®¤ Â· å¹¶æ¸…é™¤ç»“æœé¢æ¿ ==========
        function resetAllData() {
            // å¹´ä»½
            globalData.year = 2026;
            const yearInput = document.getElementById('yearInput');
            if (yearInput) yearInput.value = 2026;

            // èŠ‚æ°”æœˆï¼ˆé»˜è®¤æƒŠè›°ï¼Œç´¢å¼•1ï¼‰
            globalData.solarTermMonth = 1;
            populateMonthDial();

            // å…¬å†æœˆæ—¥
            globalData.month = 2;
            globalData.day = 12;
            const monthSelect = document.getElementById('monthSelect');
            if (monthSelect) monthSelect.value = 2;
            updateDaySelect();   // å†…éƒ¨ä¼šåŸºäºglobalData.dayé€‰ä¸­12æ—¥
            updateDateDisplay();

            // æ—¶åˆ†ç§’
            globalData.hour = 11;
            globalData.minute = 30;
            globalData.second = 15;
            const hourVal = document.getElementById('hourValue');
            if (hourVal) hourVal.innerText = 11;
            const minuteVal = document.getElementById('minuteValue');
            if (minuteVal) minuteVal.innerText = 30;
            const secondVal = document.getElementById('secondValue');
            if (secondVal) secondVal.innerText = 15;
            updateTimeDisplay();

            // æ¸…é™¤ç»“æœé¢æ¿ä¸­çš„ä¸Šä¸€æ¬¡æ’ç›˜ï¼ˆåˆ é™¤ä¸Šä¸€æ¬¡çš„ç»“æœï¼‰
            const baziYear = document.getElementById('baziYear');
            if (baziYear) baziYear.innerText = '----';
            const baziMonth = document.getElementById('baziMonth');
            if (baziMonth) baziMonth.innerText = '----';
            const baziDay = document.getElementById('baziDay');
            if (baziDay) baziDay.innerText = '----';
            const baziHour = document.getElementById('baziHour');
            if (baziHour) baziHour.innerText = '----';
            const detailTime = document.getElementById('detailTime');
            if (detailTime) detailTime.innerHTML = '';
        }

        // ========== ğŸ  é¦–é¡µæŒ‰é’®è¡Œä¸ºï¼šè®°å½•æœ¬æ¬¡ç»“æœ â†’ æ¸…ç©º â†’ å›å®¶ ==========
        function recordAndGoHome() {
            // 1. ä»å½“å‰globalDataè·å–å®Œæ•´çš„å››æŸ±ï¼Œæ„é€ å†å²è®°å½•
            const year = globalData.year;
            const month = globalData.month;
            const day = globalData.day;
            const hour = globalData.hour;
            const minute = globalData.minute;
            const second = globalData.second;
            const termIdx = globalData.solarTermMonth;

            const yGan = calcYearGanzhi(year);
            const mGan = calcMonthGanzhi(year, termIdx);
            const dGan = calcDayGanzhi(year, month, day);
            let hourZhi = getHourZhi(hour, minute);
            if (hour === 23) hourZhi = 0; // å­æ—¶ä¿®æ­£
            let hGan = calcHourGanzhi(dGan, hourZhi);

            const record = {
                datetime: `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}:${second}`,
                bazi: `${yGan} ${mGan} ${dGan} ${hGan}`,
                y: yGan, m: mGan, d: dGan, h: hGan
            };

            // 2. å°†æœ¬æ¬¡ç»“æœæ·»åŠ åˆ°å†å²è®°å½•
            addHistoryRecord(record);

            // 3. é‡ç½®æ‰€æœ‰æ•°æ®ï¼ˆåˆ é™¤ä¸Šä¸€æ¬¡çš„ç»“æœï¼Œæ¢å¤é»˜è®¤ï¼‰
            resetAllData();

            // 4. å›åˆ°é¦–é¡µå°é¢
            goToStep(1);
        }

        // ========== è½¬ç›˜ä¸æ­¥éª¤äº¤äº’ ==========
        let currentStep = 1;
        window.goToStep = function(step) {
            for (let i=1; i<=6; i++) {
                let el = document.getElementById('step'+i);
                if (el) el.classList.remove('active');
            }
            if (step === 6) {
                document.getElementById('step6').classList.add('active');
            } else {
                let nextEl = document.getElementById('step'+step);
                if (nextEl) nextEl.classList.add('active');
            }
            // è¿›å…¥ç‰¹å®šæ­¥éª¤æ—¶åˆ·æ–°æ•°æ®
            if (step === 3) populateMonthDial();
            if (step === 4) { populateMonthSelect(); updateDaySelect(); updateDateDisplay(); }
            if (step === 5) updateTimeDisplay();
            currentStep = step;
        }

        // æœˆä»½è½¬ç›˜
        window.populateMonthDial = function() {
            let div = document.getElementById('monthDial');
            if (!div) return;
            let html = '';
            for (let i=0; i<12; i++) {
                let selected = (i === globalData.solarTermMonth) ? 'selected' : '';
                html += `<div class="month-item ${selected}" data-termidx="${i}" onclick="selectTermMonth(${i})">
                            ${solarTerms[i]}<br><span style="font-size:0.9rem;">${monthGround[i]}</span>
                        </div>`;
            }
            div.innerHTML = html;
            document.getElementById('selectedMonthHint').innerHTML = `${solarTerms[globalData.solarTermMonth]} Â· ${monthGround[globalData.solarTermMonth]}`;
        }
        window.selectTermMonth = function(idx) {
            globalData.solarTermMonth = idx;
            populateMonthDial();
        }

        // æœˆä»½é€‰æ‹©ä¸‹æ‹‰æ¡†
        window.populateMonthSelect = function() {
            let sel = document.getElementById('monthSelect');
            if (!sel) return;
            let y = globalData.year;
            sel.innerHTML = '';
            for (let m=1; m<=12; m++) {
                let opt = document.createElement('option');
                opt.value = m;
                opt.text = m+'æœˆ';
                if (m === globalData.month) opt.selected = true;
                sel.appendChild(opt);
            }
        }
        window.updateDaySelect = function() {
            let m = parseInt(document.getElementById('monthSelect').value);
            globalData.month = m;
            let y = globalData.year;
            let days = daysInMonth(y, m);
            let daySel = document.getElementById('daySelect');
            daySel.innerHTML = '';
            let currDay = globalData.day;
            if (currDay > days) currDay = days;
            for (let d=1; d<=days; d++) {
                let opt = document.createElement('option');
                opt.value = d;
                opt.text = d+'æ—¥';
                if (d === currDay) opt.selected = true;
                daySel.appendChild(opt);
            }
            globalData.day = currDay;
            updateDateDisplay();
        }
        window.updateDateDisplay = function() {
            let m = document.getElementById('monthSelect')?.value || globalData.month;
            let d = document.getElementById('daySelect')?.value || globalData.day;
            globalData.month = parseInt(m);
            globalData.day = parseInt(d);
            document.getElementById('selectedDateDisplay').innerText = `${globalData.year}å¹´${globalData.month}æœˆ${globalData.day}æ—¥`;
        }

        // æ—¶åˆ†ç§’è°ƒæ•´
        window.adjustTime = function(type, delta) {
            if (type === 'hour') { globalData.hour = (globalData.hour + delta + 24) % 24; document.getElementById('hourValue').innerText = globalData.hour; }
            if (type === 'minute') { globalData.minute = (globalData.minute + delta + 60) % 60; document.getElementById('minuteValue').innerText = globalData.minute; }
            if (type === 'second') { globalData.second = (globalData.second + delta + 60) % 60; document.getElementById('secondValue').innerText = globalData.second; }
            updateTimeDisplay();
        }
        function updateTimeDisplay() {
            document.getElementById('hourValue').innerText = globalData.hour;
            document.getElementById('minuteValue').innerText = globalData.minute;
            document.getElementById('secondValue').innerText = globalData.second;
            document.getElementById('timeDisplay').innerHTML = `${globalData.hour}æ—¶${globalData.minute}åˆ†${globalData.second}ç§’`;
        }

        // å®Œæˆæ’ç›˜ -> æ˜¾ç¤ºç»“æœ
        window.completeBazi = function() {
            let year = parseInt(document.getElementById('yearInput')?.value || 2026);
            globalData.year = year;
            globalData.month = parseInt(document.getElementById('monthSelect')?.value || 2);
            globalData.day = parseInt(document.getElementById('daySelect')?.value || 12);
            let yGan = calcYearGanzhi(year);
            let mGan = calcMonthGanzhi(year, globalData.solarTermMonth);
            let dGan = calcDayGanzhi(year, globalData.month, globalData.day);
            let hourZhiIdx = getHourZhi(globalData.hour, globalData.minute);
            let hGan = calcHourGanzhi(dGan, hourZhiIdx);
            if (globalData.hour === 23) { hourZhiIdx = 0; hGan = calcHourGanzhi(dGan, hourZhiIdx); }

            document.getElementById('baziYear').innerText = yGan;
            document.getElementById('baziMonth').innerText = mGan;
            document.getElementById('baziDay').innerText = dGan;
            document.getElementById('baziHour').innerText = hGan;
            document.getElementById('detailTime').innerHTML = `å…¬å…ƒ${year}å¹´${globalData.month}æœˆ${globalData.day}æ—¥ ${globalData.hour}:${globalData.minute}:${globalData.second} Â· èŠ‚æ°”æœˆ:${solarTerms[globalData.solarTermMonth]}`;
            goToStep(6);
        }

        // ---------- é¡µé¢å¯åŠ¨åˆå§‹åŒ– ----------
        window.onload = function() {
            // å…ˆè®¾ç½®é»˜è®¤UI
            populateMonthDial();
            populateMonthSelect();
            updateDaySelect();
            updateDateDisplay();
            updateTimeDisplay();
            // ç»‘å®šå¹´ä»½è¾“å…¥ç›‘å¬
            document.getElementById('yearInput').addEventListener('input', function(e){
                globalData.year = parseInt(e.target.value) || 2026;
            });
            // æ¸…ç©ºç»“æœé¢æ¿æ˜¾ç¤ºä¸ºå ä½ç¬¦ï¼ˆä½†ä¸€å¼€å§‹æ— ç»“æœï¼‰
            resetAllData();   // ç¡®ä¿åˆå§‹çŠ¶æ€å¹²å‡€ï¼ŒåŒæ—¶æ¸…ç©ºç»“æœé¢æ¿ã€æ¢å¤é»˜è®¤å€¼
            // åˆæ¬¡å†å²åˆ—è¡¨æ¸²æŸ“
            renderHistory();
        };
    </script>
</body>
</html>